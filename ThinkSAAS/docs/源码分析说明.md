# 练习说明  
* [ ] 新建一个自定义模块
* [ ] 新建一个插件
* [ ] 使用几个系统钩子，几个系统钩子都放在模板文件里了   

# 钩子相关
钩子就是开发者在指定的位置上写出约定的代码，然后其他人按约定来进行配置就可以了 
在 `thinksass.php` 中，定义了一个 `beforeAction` 钩子。 

```php
// 添加钩子
/**
 * 该函数在插件中调用,挂载插件函数到预留的钩子上,针对app各个的插件部分，修改自Emlog
 *
 * @param string $hook
 * @param string $actionFunc
 * @return boolearn
 *
 */
function addAction($hook, $actionFunc) {
	global $tsHooks;
	$tsHooks[$hook][] = $actionFunc;
	return true;
}

// 执行钩子
/**
 * 执行挂在钩子上的函数,支持多参数 eg:doAction('post_comment', $author, $email, $url, $comment);
 * @param string $hook
 */
function doAction($hook) {
	global $tsHooks;
	$args = array_slice(func_get_args(), 1);
	if (isset($tsHooks[$hook])) {
		foreach ($tsHooks [$hook] as $function) {
			$string = call_user_func_array($function, $args);
		}
	}
	#打印钩子信息
	if ($GLOBALS['TS_CF']['hook']) var_dump($hook);
}
```

# thinksass.php 核心文件简单分析
```php
//***************************************************
// index.php 入口文件
//***************************************************
define('IN_TS', true);

define('THINKROOT', dirname(__FILE__));
define('THINKAPP', THINKROOT . '/app');
define('THINKDATA', THINKROOT . '/data');
define('THINKSAAS', THINKROOT . '/thinksaas');
define('THINKINSTALL', THINKROOT . '/install');
define('THINKPLUGIN', THINKROOT . '/plugins');
#核心配置文件 $TS_CF 系统配置变量
$TS_CF = include THINKROOT . '/thinksaas/config.php';

#装载ThinkSAAS核心
include THINKSAAS.'/thinksaas.php';

//***************************************************
// thinksaas\thinksaas.php 核心文件
//***************************************************
//加载基础函数
include 'tsFunction.php';
//安装配置文件，数据库配置判断
if (!is_file('data/config.inc.php')) {
    include 'install/index.php';
    exit;
}

//开始处理url路由，支持APP二级域名
if ($TS_CF['subdomain']) {
    ini_set("session.cookie_domain", '.' . $TS_CF['subdomain']['domain']);

    //APP独立域名支持
    if (array_search($_SERVER['HTTP_HOST'], $TS_CF['appdomain'])) {
        reurlsubdomain();
    } else {
        $arrHost = explode('.', $_SERVER['HTTP_HOST']);
        if ($arrHost[0] == 'www') {
            reurl();
        } else {
            reurlsubdomain();
        }
    }
} else {
    reurl();
}

//系统Url参数变量
$TS_URL = array(
    'app'=>isset($_GET['app']) ? tsUrlCheck($_GET['app']) : 'home',//APP专用
    'ac'=>isset($_GET['ac']) ? tsUrlCheck($_GET['ac']) : 'index',//Action专用
    'ts'=>isset($_GET['ts']) ? tsUrlCheck($_GET['ts']) : '',//ThinkSAAS专用
    'mg'=>isset($_GET['mg']) ? tsUrlCheck($_GET['mg']) : 'index',//Admin管理专用
    'my'=>isset($_GET['my']) ? tsUrlCheck($_GET['my']) : 'index',//我的社区专用
    'api'=>isset($_GET['api']) ? tsUrlCheck($_GET['api']) : 'index',//Api专用
    'plugin'=>isset($_GET['plugin']) ? tsUrlCheck($_GET['plugin']) : '',//plugin专用
    'in'=>isset($_GET['in']) ? tsUrlCheck($_GET['in']) : '',//plugin专用
    'tp'=>isset($_GET['tp']) ? tsUrlCheck($_GET['tp']) : '1',//tp 内容分页
    'page'=>isset($_GET['page']) ? tsUrlCheck($_GET['page']) : '1',//page 列表分页
    'js'=>isset($_GET['js']) ? tsUrlCheck($_GET['js']) : '1',//输出json数据 接口专用
    'userkey'=>isset($_REQUEST['userkey']) ? tsUrlCheck($_REQUEST['userkey']) : '',//加密用户ID，专为客户端使用
);

//数据库配置文件
include 'data/config.inc.php';
//加载APP配置文件
include 'app/' . $TS_URL['app'] . '/config.php';

//连接数据库
include 'mysqli.php';
$db = new MySql($TS_DB);
//加载APP数据库操作类并建立对象
include 'thinksaas/tsApp.php';
//MySQL数据库缓存
include 'thinksaas/tsMySqlCache.php';
$tsMySqlCache = new tsMySqlCache($db);

//加载网站配置文件 - 很关键的一个文件   
$TS_SITE = fileRead('data/system_options.php');
if ($TS_SITE == '') {
    $TS_SITE = $tsMySqlCache -> get('system_options');
}

//定义网站URL
define('SITE_URL', $TS_SITE['site_url']);

//装载APP应用
if (is_file('app/' . $TS_URL['app'] . '/class.' . $TS_URL['app'] . '.php')) {

    include_once 'app/' . $TS_URL['app'] . '/class.' . $TS_URL['app'] . '.php';
    $new[$TS_URL['app']] = new $TS_URL['app']($db);

    //在执行action之前加载
    doAction('beforeAction'); 

    //全站通用数据加载
    include 'thinksaas/common.php';

    if(is_file('app/'.$TS_URL['app'].'/action.'.$TS_URL['app'].'.php')){
        //面向对象的写法
        include_once 'app/'.$TS_URL['app'].'/action.'.$TS_URL['app'].'.php';
        $appAction = $TS_URL['app'].'Action';
        $newAction = new $appAction($db);
        if(!method_exists($newAction,$ac)){
            qiMsg( '未定义'.$ac.'方法！');
        }
        $newAction->$ac();
    }else{
        //面向目录和文件的逻辑加载写法
        include 'app.php';
    }
    
} else {
    ts404();
}
```

# 路由分析说明
其实看上面的 `thinksaas.php` 代码路由大概清楚了，我先简单的说一下，然后再来根据实际的url来进行判断。    

```php
//系统Url参数变量 --- 一些关键的URL参数
$TS_URL = array(
    'app'=>isset($_GET['app']) ? tsUrlCheck($_GET['app']) : 'home',//APP专用  组件名
    'ac'=>isset($_GET['ac']) ? tsUrlCheck($_GET['ac']) : 'index',//Action专用 

    'ts'=>isset($_GET['ts']) ? tsUrlCheck($_GET['ts']) : '',//ThinkSAAS专用
    'mg'=>isset($_GET['mg']) ? tsUrlCheck($_GET['mg']) : 'index',//Admin管理专用
    'my'=>isset($_GET['my']) ? tsUrlCheck($_GET['my']) : 'index',//我的社区专用
    'api'=>isset($_GET['api']) ? tsUrlCheck($_GET['api']) : 'index',//Api专用
    'plugin'=>isset($_GET['plugin']) ? tsUrlCheck($_GET['plugin']) : '',//plugin专用
    'in'=>isset($_GET['in']) ? tsUrlCheck($_GET['in']) : '',//plugin专用
    'tp'=>isset($_GET['tp']) ? tsUrlCheck($_GET['tp']) : '1',//tp 内容分页
    'page'=>isset($_GET['page']) ? tsUrlCheck($_GET['page']) : '1',//page 列表分页
    'js'=>isset($_GET['js']) ? tsUrlCheck($_GET['js']) : '1',//输出json数据 接口专用
    'userkey'=>isset($_REQUEST['userkey']) ? tsUrlCheck($_REQUEST['userkey']) : '',//加密用户ID，专为客户端使用
);

$filename = 'app/' . $TS_URL['app'] . '/class.' . $TS_URL['app'] . '.php';
// app/home/class.home.php 模块的模型类   

$filename = 'app/'.$TS_URL['app'].'/action.'.$TS_URL['app'].'.php';
// app/home/action.home.php 模块的控制器类 所有action写在单个文件中
// 这个我定义模块时，来进行尝试看看 
// 类命名为 class <appName>Action { }

// thinksaas\app.php 目录文件的action加载方法    
$filename = 'app/' . $TS_URL['app'] . '/action/' . $TS_URL['ac'] . '.php';
// app/home/action/index.php
```

默认的访问链接为：`http://thinksaas.test/index.php?app=home&tc=action`  

路由加载搞清楚了，下一步来看看插件是怎么回事。  

应用组件位置：app/目录下。应用组件是thinksaas大型模块功能，比如小组（group）、文章(article)等，所有功能模块的开发都是基于应用组件的开发方式进行。

应用组件开发介绍：https://www.thinksaas.cn/article/show/7/

组件和插件开发，官网论坛右侧都有直达的文档，待会儿根据描述来进行照猫画虎应该可以快速上手。  


# API开发说明
模块名为api或者控制器名为api时，会进行跨域请求的处理。  
```php
if($app=='api' || $ac=='api'){

// 普通的action会包含模板文件，然后响应输出
include template ( 'index' );

// api 的话，会有单独一个参数出来，=_= 这个作者的文件组织真是随性，100个api，不得建100个文件了，太麻烦了    
'api'=> isset($_GET['api']) ? tsUrlCheck($_GET['api']) : 'index',//Api专用 
// app\article\action\api.php
if (is_file ( 'app/' . $TS_URL['app'] . '/action/api/' . $TS_URL['api'] . '.php' )) {
	include_once 'app/' . $TS_URL['app'] . '/action/api/' . $TS_URL['api'] . '.php';
} else {
	qiMsg ( 'sorry:no api!' );
}
// app\article\action\api
$jsonData = json_encode(array(
    'status'=> 1,
    'msg'=> 'success',
    'data'=> array(
        ...
    ),
));
echo $jsonData;
```

来实操一下吧，光光是看源码，单纯地分析一下还是太浅了，我需要写写代码才行。